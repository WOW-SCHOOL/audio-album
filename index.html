<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WOW SCHOOL — English File: Beginner</title>
  <link rel="preload" href="playlist.json" as="fetch" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <!-- Если захотите поставить картинку-аватар: положите файл в /img/logo.png -->
      <!-- <img src="img/logo.png" alt="WOW SCHOOL" class="brand-logo"> -->
      <span class="brand-text">WOW SCHOOL</span>
    </div>
    <h1 class="page-title">English File: Beginner</h1>
  </header>

  <main class="wrap" id="app">
    <section class="player-card">
      <div class="now">
        <div class="meta">
          <div class="track-title" id="trackTitle">—</div>
          <div class="track-sub" id="trackSub">0:00 / 0:00</div>
        </div>
        <div class="controls">
          <button class="btn" id="prevBtn" title="Предыдущий трек">⏮</button>
          <button class="btn" id="playPauseBtn" title="Пуск / Пауза">▶️/⏸</button>
          <button class="btn" id="nextBtn" title="Следующий трек">⏭</button>
        </div>
      </div>

      <div class="progress">
        <input type="range" id="seek" min="0" value="0" step="0.1" />
      </div>

      <div class="list-wrap">
        <ol class="list" id="trackList" aria-label="Список треков"></ol>
      </div>

      <audio id="audio" preload="metadata" crossorigin="anonymous"></audio>
    </section>
  </main>

  <footer class="foot">
    <div class="iframe-hint">
      <!-- Подсказка для вставки в Miro оставлена здесь ПОД СПОЙЛЕРОМ, но на странице не видна -->
      <!-- iframe для Miro:
      <iframe src="https://ВАШ-ДОМЕН/index.html" width="100%" height="520" frameborder="0" allow="autoplay"></iframe>
      см. также README (инструкция по публикации). -->
    </div>
  </footer>

  <script>
  (function () {
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    const audio = $('#audio');
    const list = $('#trackList');
    const seek = $('#seek');
    const titleEl = $('#trackTitle');
    const subEl = $('#trackSub');
    const playBtn = $('#playPauseBtn');
    const nextBtn = $('#nextBtn');
    const prevBtn = $('#prevBtn');

    let playlist = [];
    let idx = 0;
    let seekingByCode = false;

    const fmt = (t) => {
      if (!isFinite(t)) return '0:00';
      const m = Math.floor(t / 60);
      const s = Math.floor(t % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    };

    // Подгружаем плейлист
    fetch('playlist.json', { cache: 'no-store' })
      .then(r => {
        if (!r.ok) throw new Error('Не удалось загрузить playlist.json');
        return r.json();
      })
      .then(data => {
        playlist = Array.isArray(data.tracks) ? data.tracks : [];
        renderList();
        load(0, false);
      })
      .catch(err => {
        console.error(err);
        titleEl.textContent = 'Ошибка загрузки плейлиста';
      });

    function renderList() {
      list.innerHTML = '';
      playlist.forEach((t, i) => {
        const li = document.createElement('li');
        li.className = 'row';
        li.dataset.i = i.toString();
        li.innerHTML = `
          <button class="row-btn" title="Воспроизвести">
            <span class="row-idx">${i + 1}</span>
            <span class="row-title">${t.title ?? 'Без названия'}</span>
            <span class="row-time" id="d_${i}">—:—</span>
          </button>
        `;
        li.querySelector('.row-btn').addEventListener('click', () => load(i, true));
        list.appendChild(li);

        // Пытаемся получить длительность без начала проигрывания
        const probe = new Audio();
        probe.preload = 'metadata';
        probe.src = t.file;
        probe.addEventListener('loadedmetadata', () => {
          const dur = fmt(probe.duration);
          const cell = document.getElementById('d_' + i);
          if (cell) cell.textContent = dur;
        }, { once: true });
        probe.addEventListener('error', () => {
          const cell = document.getElementById('d_' + i);
          if (cell) cell.textContent = '—';
        }, { once: true });
      });
    }

    function highlight() {
      $$('.row').forEach(el => el.classList.remove('active'));
      const cur = list.querySelector(`.row[data-i="${idx}"]`);
      if (cur) cur.classList.add('active');
    }

    function load(i, autoplay) {
      if (!playlist.length) return;
      idx = (i + playlist.length) % playlist.length;
      const tr = playlist[idx];
      audio.src = tr.file;
      titleEl.textContent = tr.title ?? 'Без названия';
      subEl.textContent = '0:00 / 0:00';
      highlight();

      // Стартуем по готовности метаданных
      audio.addEventListener('loadedmetadata', () => {
        seek.max = audio.duration || 0;
        updateTime();
        if (autoplay) audio.play().catch(() => {/* браузер мог заблокировать автоплей */});
      }, { once: true });

      // Обработка ошибок трека
      audio.addEventListener('error', () => {
        const cell = document.getElementById('d_' + idx);
        if (cell) cell.textContent = 'ERR';
        // Переходим к следующему, чтобы пользователь не застревал на битом файле
        next();
      }, { once: true });
    }

    function playPause() {
      if (audio.paused) audio.play().catch(() => {});
      else audio.pause();
    }
    function next() { load(idx + 1, true); }
    function prev() { load(idx - 1, true); }

    function updateTime() {
      if (!seekingByCode) seek.value = audio.currentTime || 0;
      subEl.textContent = `${fmt(audio.currentTime)} / ${fmt(audio.duration)}`;
    }

    // события плеера
    audio.addEventListener('timeupdate', updateTime);
    audio.addEventListener('ended', next);

    // ползунок
    seek.addEventListener('input', e => {
      seekingByCode = true;
      audio.currentTime = Number(seek.value || 0);
      seekingByCode = false;
    });

    // кнопки
    playBtn.addEventListener('click', playPause);
    nextBtn.addEventListener('click', next);
    prevBtn.addEventListener('click', prev);

    // быстрая клавиатура
    window.addEventListener('keydown', (e) => {
      if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
      if (e.code === 'Space') { e.preventDefault(); playPause(); }
      if (e.code === 'ArrowRight') next();
      if (e.code === 'ArrowLeft') prev();
    });
  })();
  </script>
</body>
</html>
